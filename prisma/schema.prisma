generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public"]
}

model applications {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @default(now()) @db.Timestamptz(6)
  full_name         String
  mobile_number     String
  email             String?
  city              String?
  product_category  String
  product_type      String
  application_stage String    @default("started")
  status            String    @default("new")
  source            String    @default("website")
  metadata          Json?     @default("{}")
  address_line_1    String?
  address_line_2    String?
  assigned_to       String?   @db.Uuid
  ip                String?   @db.VarChar(64)
  pincode           String?
  state             String?
  user_agent        String?   @db.VarChar(512)
  profile_id        String?   @db.Uuid
  
  // ✅ UPDATED: SetNull keeps the application if the user is deleted
  profile           profiles? @relation(fields: [profile_id], references: [id], onDelete: SetNull)

  @@index([profile_id], map: "idx_applications_profile_id")
  @@schema("public")
}

model contact_messages {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  full_name     String
  email         String
  mobile_number String
  city          String?
  state         String?
  subject       String?
  status        String?  @default("new")
  ip            String?  @db.VarChar(64)
  user_agent    String?  @db.VarChar(512)
  message       String
  reason        String?

  @@schema("public")
}

model profiles {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  full_name      String?
  email          String?
  phone          String?          @unique(map: "idx_profiles_phone_unique") @db.VarChar(24)
  address        String?
  photo_url      String?
  created_at     DateTime?        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime?        @default(now()) @db.Timestamptz(6)
  role           user_role        @default(user)
  phone_verified Boolean          @default(false)
  verified_at    DateTime?        @db.Timestamptz(6)
  applications   applications[]
  auth_sessions  auth_sessions[]
  otp_challenges otp_challenges[]

  @@index([phone], map: "idx_profiles_phone")
  @@schema("public")
}

model otp_challenges {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  phone           String    @db.VarChar(24)
  otp_hash        String
  expires_at      DateTime  @db.Timestamptz(6)
  consumed        Boolean   @default(false)
  verify_attempts Int       @default(0)
  ip              String?   @db.VarChar(64)
  user_agent      String?   @db.VarChar(512)
  created_at      DateTime  @default(now()) @db.Timestamptz(6)
  profile_id      String?   @db.Uuid

  // ✅ UPDATED: Cascade deletes OTP logs if user is deleted
  profile         profiles? @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([phone, created_at], map: "idx_otp_phone_created_at")
  @@index([created_at], map: "idx_otp_created_at")
  @@index([profile_id], map: "idx_otp_profile_id")
  @@schema("public")
}

model role_change_audit {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actor_user_id  String    @db.Uuid
  target_user_id String    @db.Uuid
  old_role       user_role
  new_role       user_role
  created_at     DateTime  @default(now()) @db.Timestamptz(6)

  @@schema("public")
}

model application_assignments {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  application_id String   @db.Uuid
  agent_user_id  String   @db.Uuid
  assigned_by    String   @db.Uuid
  assigned_at    DateTime @default(now()) @db.Timestamptz(6)
  is_active      Boolean  @default(true)

  @@index([application_id])
  @@index([agent_user_id])
  @@schema("public")
}

model application_remarks {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  application_id String   @db.Uuid
  agent_user_id  String   @db.Uuid
  remark         String
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  metadata       Json?

  @@index([application_id])
  @@index([agent_user_id])
  @@schema("public")
}

model application_status_logs {
  id             String                          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  application_id String                          @db.Uuid
  actor_user_id  String                          @db.Uuid
  actor_role     application_status_actor_role
  action         application_status_action
  from_status    String
  to_status      String
  reason         String?
  created_at     DateTime                        @default(now()) @db.Timestamptz(6)

  @@index([application_id])
  @@index([actor_user_id])
  @@index([created_at])
  @@schema("public")
}

model auth_sessions {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  profile_id String   @db.Uuid
  ip         String?  @db.VarChar(64)
  user_agent String?  @db.VarChar(512)
  revoked    Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  expires_at DateTime @db.Timestamptz(6)
  
  // ✅ UPDATED: Cascade deletes session if user is deleted
  profiles   profiles @relation(fields: [profile_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([profile_id])
  @@schema("public")
}

enum application_status_actor_role {
  agent
  admin

  @@schema("public")
}

enum application_status_action {
  proposed
  approved
  rejected

  @@schema("public")
}

enum user_role {
  user
  admin
  agent

  @@schema("public")
}